-   name: Start python webapp
    hosts: '{{ vm_name }}'
    become: yes
    become_user: root

    tasks:
    -   name: ensure required packages installed
        package: name={{item}} state=latest update_cache=yes cache_valid_time=3600
        with_items:
        - python
        - python-pip
        - python-mysqldb
        - mysql-client
#        - python-dev
        - nginx
        - git

    -   name: git clone
        command: git clone https://github.com/bhavinzlvd7/flask_app_with_mysql.git creates=flask_app_with_mysql

    -   name: pip install -r requirements.txt
        command: pip install -r flask_app_with_mysql/requirements.txt

    -   name: Ansible Jinja2 Example
        template:
            src: 'templates/flask_sql_config.j2'
            dest: 
            mode: 0777

#    -   name: export FLASK_APP application.py
#        shell: export "FLASK_APP=flask-hello-world/application.py"

    -   name: export FLASK_APP application.py and Start flask run -h 0.0.0.0
        shell: export "FLASK_APP=flask_app_with_mysql/app.py"; nohup flask run -h 0.0.0.0 &
        register: out
    -   debug: msg="{{ out.stdout }}"
    -   debug: msg="{{ out.stderr }}"

    -   name: Check flask is running
        shell: ps -afx | grep flask | grep -v grep
        register: out
    -   debug: msg="{{ out.stdout }}"
    -   debug: msg="{{ out.stderr }}"
